"use strict";
var ServiceScope_1 = require('../../serviceScope/ServiceScope');
var MockFetchProvider_1 = require('../../httpClient/test/MockFetchProvider');
var FetchProvider_1 = require('../../httpClient/FetchProvider');
var MockRandomProvider_1 = require('../../httpClient/test/MockRandomProvider');
var RandomProvider_1 = require('../../common/RandomProvider');
var OAuthTokenProvider_1 = require('../OAuthTokenProvider');
var sp_client_shared_1 = require('@ms/sp-client-shared');
var assert = chai.assert;
describe('OAuthTokenProvider tests', function () {
    var testCase = 0;
    var rootScope = ServiceScope_1.default.startNewRoot();
    var fetchProvider = new MockFetchProvider_1.default(rootScope);
    rootScope.provide(FetchProvider_1.fetchProviderServiceKey, fetchProvider);
    var randomProvider = new MockRandomProvider_1.default(rootScope);
    rootScope.provide(RandomProvider_1.randomProviderServiceKey, randomProvider);
    rootScope.finish();
    var tokenProvider = rootScope.consume(OAuthTokenProvider_1.oAuthTokenProviderServiceKey);
    beforeEach(function () {
        testCase++;
    });
    it('Should get the correct token in case of a successfull request', function () {
        fetchProvider.expect({
            expectedUrl: '/_api/contextinfo',
            responseObject: {
                'FormDigestValue': 'DIGEST_1',
                'FormDigestTimeoutSeconds': 30
            }
        });
        setFetchProviderExpectation({
            requestAssertions: function (request) {
                assert.isTrue(request.headers.has('X-RequestDigest'));
            },
            responseObject: {
                access_token: 'test_token',
                expires_on: Date.now() / 1000 + 10000,
                not_before: '1467752142',
                resource: 'resource',
                scope: 'user_impersonation',
                token_type: 'Bearer'
            }
        });
        return tokenProvider.getOAuthToken(getTestResource()).then(function (oAuthToken) {
            assert.equal(oAuthToken.token, 'test_token');
        });
    });
    it('should get the right error in case of an erroneous request', function () {
        setFetchProviderExpectation({
            requestAssertions: function (request) {
                assert.isTrue(request.headers.has('X-RequestDigest'));
            },
            responseObject: {
                error: {
                    message: 'error',
                    code: '1, some.exception'
                }
            },
            responseOptions: {
                status: 400
            }
        });
        return tokenProvider.getOAuthToken(getTestResource()).then(function () { assert.fail(); }, function (error) {
            chai.expect(error).instanceof(sp_client_shared_1.OAuthUtilityError);
            var tokenUtilError = error;
            assert.equal(tokenUtilError.type, sp_client_shared_1.OAuthUtilityErrorType.serverError);
            assert.equal(tokenUtilError.serverErrorCode, 1);
            assert.equal(tokenUtilError.message, 'error');
        });
    });
    /* tslint:disable no-any */
    function setFetchProviderExpectation(expectations) {
        /* tslint:enable no-any */
        fetchProvider.expect({
            expectedUrl: '/_api/SP.OAuth.Token/Acquire',
            expectedRequestHeaders: [
                new MockFetchProvider_1.MockedHeader('Content-Type', 'application/json; charset=utf-8'),
                new MockFetchProvider_1.MockedHeader('Odata-Version', '4.0'),
                new MockFetchProvider_1.MockedHeader('Accept', 'application/json;odata.metadata=minimal')
            ],
            requestAssertions: expectations.requestAssertions,
            responseObject: expectations.responseObject,
            responseOptions: expectations.responseOptions
        });
    }
    function getTestResource() {
        return 'resource' + testCase;
    }
});

//# sourceMappingURL=OAuthTokenProvider.test.js.map
