/* tslint:disable:no-unused-variable */
"use strict";
var ServiceScope_1 = require('../ServiceScope');
var ServiceKey_1 = require('../ServiceKey');
var assert = chai.assert;
var aServiceKey = ServiceKey_1.default.createCustom('sp-client-base:A', function (serviceScope) { return new A(serviceScope, 'autocreated-A'); });
var bServiceKey = ServiceKey_1.default.createCustom('sp-client-base:B', function (serviceScope) {
    var b = new B(serviceScope);
    b.name = 'autocreated-B';
    return b;
});
var cServiceKey = ServiceKey_1.default.createCustom('sp-client-base:C', function (serviceScope) {
    var c = new C(serviceScope);
    c.name = 'autocreated-C';
    return c;
});
var A = (function () {
    function A(serviceScope, name) {
        var _this = this;
        this.name = name;
        serviceScope.whenFinished(function () {
            _this.b = serviceScope.consume(bServiceKey);
            _this.c = serviceScope.consume(cServiceKey);
        });
    }
    return A;
}());
var B = (function () {
    function B(serviceScope) {
        var _this = this;
        this.name = 'B';
        serviceScope.whenFinished(function () {
            _this.a = serviceScope.consume(aServiceKey);
            _this.c = serviceScope.consume(cServiceKey);
        });
    }
    return B;
}());
var C = (function () {
    function C(serviceScope) {
        var _this = this;
        this.name = 'C';
        serviceScope.whenFinished(function () {
            _this.a = serviceScope.consume(aServiceKey);
            _this.b = serviceScope.consume(bServiceKey);
        });
    }
    return C;
}());
describe('ServiceScope tests', function () {
    describe('Circular dependency tests (A, B, C)', function () {
        it('should autocreate objects if they are not provided by any scope', function (done) {
            var rootScope = ServiceScope_1.default.startNewRoot();
            rootScope.finish();
            var childScope = rootScope.startNewChild();
            childScope.finish();
            var a = childScope.consume(aServiceKey);
            var b = childScope.consume(bServiceKey);
            var c = childScope.consume(cServiceKey);
            assert.equal(a.name, 'autocreated-A');
            assert.equal(a.b.name, 'autocreated-B');
            assert.equal(a.c.name, 'autocreated-C');
            assert.equal(b.name, 'autocreated-B');
            assert.equal(b.a.name, 'autocreated-A');
            assert.equal(b.c.name, 'autocreated-C');
            assert.equal(c.name, 'autocreated-C');
            assert.equal(c.a.name, 'autocreated-A');
            assert.equal(c.b.name, 'autocreated-B');
            // Also verify that we get back the same objects if we consume from the root
            var a2 = rootScope.consume(aServiceKey);
            var b2 = rootScope.consume(bServiceKey);
            var c2 = rootScope.consume(cServiceKey);
            assert.equal(a, a2);
            assert.equal(b, b2);
            assert.equal(c, c2);
            done();
        });
        it('should NOT autocreate objects if they are provded', function (done) {
            var rootScope = ServiceScope_1.default.startNewRoot();
            rootScope.finish();
            var childScope = rootScope.startNewChild();
            var a = childScope.provide(aServiceKey, new A(childScope, 'A'));
            var b = childScope.createAndProvide(bServiceKey, B);
            var c = childScope.createAndProvide(cServiceKey, C);
            childScope.finish();
            assert.equal(a.name, 'A'); // i.e. not 'autocreated-A'
            assert.equal(a.b.name, 'B'); // i.e. not 'autocreated-B'
            assert.equal(a.c.name, 'C'); // i.e. not 'autocreated-C'
            assert.equal(b.name, 'B');
            assert.equal(b.a.name, 'A');
            assert.equal(b.c.name, 'C');
            assert.equal(c.name, 'C');
            assert.equal(c.a.name, 'A');
            assert.equal(c.b.name, 'B');
            // Also verify that we get back the same objects if we consume after finish()
            var a2 = childScope.consume(aServiceKey);
            var b2 = childScope.consume(bServiceKey);
            var c2 = childScope.consume(cServiceKey);
            assert.equal(a, a2);
            assert.equal(b, b2);
            assert.equal(c, c2);
            done();
        });
        it('should allow new instances to be introduced in a child scope', function (done) {
            var rootScope = ServiceScope_1.default.startNewRoot();
            rootScope.finish();
            // Start with the same example from above
            var childScope = rootScope.startNewChild();
            var a = childScope.provide(aServiceKey, new A(childScope, 'A'));
            var b = childScope.createAndProvide(bServiceKey, B);
            var c = childScope.createAndProvide(cServiceKey, C);
            childScope.finish();
            // Add a grandChildScope that introduces a new A and B instance
            var grandChildScope = childScope.startNewChild();
            var otherA = grandChildScope.provide(aServiceKey, new A(grandChildScope, 'other-A'));
            var otherB = grandChildScope.createAndProvide(bServiceKey, B);
            otherB.name = 'other-B';
            grandChildScope.finish();
            assert.equal(otherA.name, 'other-A');
            assert.equal(otherA.b.name, 'other-B');
            assert.equal(otherA.c.name, 'C');
            assert.equal(otherB.name, 'other-B');
            assert.equal(otherB.a.name, 'other-A');
            assert.equal(otherB.c.name, 'C');
            // But note that if we consume C, we get the parent's instance that is
            // still referring to the old A and B.  This is a little counterintuitive, but
            // the only other possible design would be to autocreate a new instance of C
            // (which has even more problems).
            var c2 = grandChildScope.consume(cServiceKey);
            assert.equal(c2.name, 'C');
            assert.equal(c2.a.name, 'A'); // i.e. not 'other-A'
            assert.equal(c2.b.name, 'B'); // i.e. not 'other-B'
            done();
        });
        it('should support creating objects without adding to any scope', function (done) {
            var rootScope = ServiceScope_1.default.startNewRoot();
            // i.e. we don't insist that objects be added to a scope.  But note that
            // as a result we end up with 'A' and 'autocreated-A' when other objects
            // try to consume it
            var a = new A(rootScope, 'A');
            var b = new B(rootScope);
            rootScope.finish();
            var c = new C(rootScope);
            assert.equal(a.name, 'A');
            assert.equal(a.b.name, 'autocreated-B');
            assert.equal(a.c.name, 'autocreated-C');
            assert.equal(b.name, 'B');
            assert.equal(b.a.name, 'autocreated-A');
            assert.equal(b.c.name, 'autocreated-C');
            assert.equal(c.name, 'C');
            assert.equal(c.a.name, 'autocreated-A');
            assert.equal(c.b.name, 'autocreated-B');
            done();
        });
    });
});

//# sourceMappingURL=ServiceScope.test.js.map
