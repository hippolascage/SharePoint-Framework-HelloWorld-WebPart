{"version":3,"sources":["configureWebpack/ConfigureWebpackTask.ts"],"names":[],"mappings":"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","file":"configureWebpack/ConfigureWebpackTask.js","sourcesContent":["import * as lodash from 'lodash';\r\nimport * as gulp from 'gulp';\r\nimport * as path from 'path';\r\nimport * as webpack from 'webpack';\r\nimport { WebpackTask } from 'gulp-core-build-webpack';\r\nimport { ISetWebpackPublicPathLoaderOptions }\r\n  from '@microsoft/loader-set-webpack-public-path/lib/SetWebpackPublicPathLoader';\r\nimport { IClientSideComponentManifest } from '@microsoft/sp-module-interfaces';\r\n\r\nimport OdspGulpTask, { INonAMDExternalModuleConfig } from './../OdspGulpTask';\r\nimport constants from './../constants';\r\n\r\nexport interface IConfigureWebpackTaskConfig {\r\n  webpack?: WebpackTask;\r\n  webpackPublicPathOptions?: ISetWebpackPublicPathLoaderOptions;\r\n  libraryName?: string;\r\n  libraryTarget?: string;\r\n\r\n  /**\r\n   * An optional callback can be provided that allows the generated webpack configuration to be modified.\r\n   */\r\n  additionalConfiguration?: (generatedConfiguration: webpack.Configuration) => webpack.Configuration;\r\n}\r\n\r\nexport interface IBundleEntry {\r\n  entry: string;\r\n  manifest: string;\r\n  outputPath: string;\r\n  stringsExternalName?: string;\r\n}\r\n\r\nconst supportedWebpackLibraryTargets: string[] = ['var', 'this', 'commonjs', 'commonjs2', 'amd', 'umd'];\r\n\r\nexport const fileLoaderExts: string[] = ['jpg', 'png', 'woff', 'eot', 'ttf', 'svg', 'gif'];\r\n\r\nconst isRunningInNpmMode: boolean = process.argv.indexOf('--npm') !== -1;\r\n\r\n/**\r\n * Configures the gulp-core-build-webpack task with some smart defaults based on the package configuration.\r\n *\r\n * Example:\r\n *  IN:\r\n *    setConfig({\r\n *      webpack: <reference to webpack task>,\r\n *      webpackPublicPathOptions: <options for @microsoft/loader-set-webpack-public-path>,\r\n *      libraryName: <optional library name - set this if the library should be a global on the window>\r\n *    })\r\n *    buildConfig.properties.entries = [{\r\n *      \"entry\": \"./lib/App.js\",\r\n *      \"manifest\": \"./src/app.manifest.json\",\r\n *      \"outputPath\": \"dist/app.bundle.js\"\r\n *    }]\r\n *    buildConfig.properties.externals = {\r\n *      \"react-dom\": \"node_modules/react-dom/dist/react-dom.js\",\r\n *      \"react\": \"node_modules/react/dist/react.js\",\r\n *      \"flux\": \"node_modules/flux/dist/flux.js\",\r\n *    }\r\n *\r\n *  OUT:\r\n *    set webpack config to:\r\n *    {\r\n *        context: ... root path ...,\r\n *        entry: { ... mapping of names to entries ... },\r\n *        resolveLoader: {\r\n *          alias: undefined,\r\n *          root: ... node_modules ...\r\n *        },\r\n *        resolve: {\r\n *          extensions: ['', '.tsx', '.ts', '.jsx', '.js', '.less', '.css', '.html'],\r\n *          modulesDirectories: [ ... root path + /node_modules ],\r\n *          alias: { }\r\n *        },\r\n *        output: {\r\n *          library: <library name, if provided>,\r\n *          libraryTarget: 'umd',\r\n *          path: ... dist folder ...,\r\n *          publicPath: this.taskConfig.publicPath,\r\n *          filename: PRODUCTION ? '[name]_[chunkhash].js' : '[name].js'\r\n *        },\r\n *        externals: [ ... externals names ... ],\r\n *        module: {\r\n *          preLoaders: [],\r\n *          noParse: [ /\\.map$/ ],\r\n *          loaders: [\r\n *            {\r\n *              test: /\\.module.scss$/,\r\n *              loader:\r\n *                'load-themed-styles!css-loader?&modules&localIdentName=[name]__[local]___[hash:base64:5]'\r\n *            },\r\n *            {\r\n *              test: /\\.scss$/, exclude: /\\.module.scss$/,\r\n *              loader: 'load-themed-styles!css-loader'\r\n *            },\r\n *            {\r\n *              test: /\\.(jpg|png|woff|eot|ttf|svg|gif)$/,\r\n *              loader: '@microsoft/loader-cased-file?name=[name]_[hash].[ext]'\r\n *            }\r\n *          ]\r\n *        },\r\n *        plugins: []\r\n *      }\r\n */\r\nexport class ConfigureWebpackTask extends OdspGulpTask<IConfigureWebpackTaskConfig> {\r\n  public name: string = 'configureWebpack';\r\n  public taskConfig: IConfigureWebpackTaskConfig = {\r\n    libraryName: undefined,\r\n    webpack: undefined,\r\n    webpackPublicPathOptions: undefined,\r\n    additionalConfiguration: undefined\r\n  };\r\n\r\n  private _baseConfig: webpack.Configuration = {\r\n    module: {\r\n      loaders: [\r\n        {\r\n          loader: '@microsoft/loader-load-themed-styles!css-loader',\r\n          test: /\\.css$/\r\n        },\r\n        {\r\n          loader: '@microsoft/loader-cased-file?name=[name:lower]_[hash].[ext]',\r\n          test: new RegExp(`\\.(${fileLoaderExts.map((ext: string) => lodash.escapeRegExp(ext)).join('|')})$`)\r\n        },\r\n        {\r\n          loader: 'json-loader',\r\n          test: /\\.json$/\r\n        }\r\n      ],\r\n      noParse: [ /\\.map$/ ],\r\n      postLoaders: [],\r\n      preLoaders: [\r\n        {\r\n          test:   /\\.js$/,\r\n          loader: 'source-map-loader'\r\n        }\r\n      ]\r\n    },\r\n    resolve: {\r\n      alias: {},\r\n      modulesDirectories: [\r\n        '',\r\n        'node_modules',\r\n        'lib'\r\n      ]\r\n    },\r\n    resolveLoader: {\r\n      alias: undefined,\r\n      root: path.join(__dirname, '..', '..', 'node_modules'),\r\n      moduleTemplates: ['@microsoft/loader-*']\r\n    }\r\n  };\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    // Get the webpack default configuration\r\n    const defaultConfig: webpack.Configuration = {};\r\n    /* tslint:disable:no-any */\r\n    (new (webpack as any).WebpackOptionsDefaulter()).process(defaultConfig);\r\n    /* tslint:enable:no-any */\r\n\r\n    // Include the default moduleTemplates, if there are any defaults\r\n    if (defaultConfig.resolveLoader &&\r\n        defaultConfig.resolveLoader.moduleTemplates &&\r\n        !!defaultConfig.resolveLoader.moduleTemplates.length) {\r\n      this._baseConfig.resolveLoader.moduleTemplates.push(...defaultConfig.resolveLoader.moduleTemplates);\r\n    }\r\n  }\r\n\r\n  public setConfig(config: IConfigureWebpackTaskConfig): void {\r\n    if (config.webpack && config.webpack.name !== 'webpack') {\r\n      this.logWarning('Setting webpack property to non-\"gulp-core-build-webpack\"-type will ' +\r\n                      'prevent configuration');\r\n    }\r\n\r\n    super.setConfig(config);\r\n  }\r\n\r\n  public getKarmaConfig(\r\n    postLoaders: webpack.Loader[],\r\n    externals: webpack.ExternalsElement[]): webpack.Configuration {\r\n    const testAddons: webpack.Configuration = {\r\n      externals: externals,\r\n      module: {\r\n        loaders: [{\r\n          loader: 'imports?define=>false',\r\n          test: /sinon\\.js$/\r\n        }],\r\n        postLoaders: postLoaders\r\n      },\r\n      plugins: [new webpack.DefinePlugin({\r\n        UNIT_TEST: true\r\n      })],\r\n      resolve: {\r\n        alias: {}\r\n      }\r\n    };\r\n\r\n    return this._appendToBaseConfig(testAddons);\r\n  }\r\n\r\n  public executeTask(gulp: gulp.Gulp, completeCallback: (error?: string) => void): NodeJS.ReadWriteStream {\r\n    if (!this.taskConfig.webpack) {\r\n      this.logWarning('\"webpack\" is not defined in the task configuration. Nothing to configure.');\r\n      completeCallback();\r\n      return;\r\n    }\r\n\r\n    if (!this.buildConfig.properties) {\r\n      this._logNoEntriesWarning();\r\n      this._setWebpackConfig({});\r\n      completeCallback();\r\n      return;\r\n    }\r\n\r\n    // If the library target is explicitly set, ensure that it's set to one of the valid webpack library targets.\r\n    if (this.taskConfig.libraryTarget && supportedWebpackLibraryTargets.indexOf(this.taskConfig.libraryTarget) === -1) {\r\n      this.logError(`\"${this.taskConfig.libraryTarget}\" is not a valid library target type.`);\r\n      completeCallback();\r\n      return;\r\n    }\r\n\r\n    /* tslint:disable:typedef variable-name */\r\n    const StatsPlugin = require('webpack-stats-plugin');\r\n    const VisualizerPlugin = require('webpack-visualizer-plugin');\r\n    /* tslint:enable:typedef variable-name */\r\n\r\n    const entries: IBundleEntry[] = this.properties.entries || [];\r\n    const externals: { [name: string]: string | INonAMDExternalModuleConfig } = this.properties.externals || {};\r\n\r\n    const externalsKeys: string[] = Object.keys(externals);\r\n\r\n    const localizedResources: { [name: string]: string } = this.properties.localizedResources || {};\r\n    const localizedResourcesKeys: string[] = Object.keys(localizedResources);\r\n\r\n    if (entries.length === 0) {\r\n      this._logNoEntriesWarning();\r\n    }\r\n\r\n    this.logVerbose(`${entries.length} entries specified.`);\r\n    this.logVerbose(`${externalsKeys.length} externals specified.`);\r\n    this.logVerbose(`${localizedResourcesKeys.length} localized resources specified.`);\r\n\r\n    localizedResourcesKeys.forEach((key: string) => {\r\n      if (externalsKeys.indexOf(key) !== -1) {\r\n        this.logError(`Invalid Configuration: Key \"${key}\" is specified in both externals and localizedResources.`);\r\n      }\r\n    });\r\n\r\n    const webpackPublicPathOptions: ISetWebpackPublicPathLoaderOptions =\r\n        lodash.clone(this.taskConfig.webpackPublicPathOptions) || {};\r\n    if (!webpackPublicPathOptions.systemJs) {\r\n      lodash.merge(webpackPublicPathOptions, {\r\n        scriptPath: constants.defaultWebpackPublicPathScriptName\r\n      });\r\n    }\r\n\r\n    /* tslint:disable:typedef */\r\n    const setWebpackPublicPath = require('@microsoft/loader-set-webpack-public-path');\r\n    /* tslint:enable:typedef */\r\n    setWebpackPublicPath.setOptions(webpackPublicPathOptions);\r\n\r\n    // When we loop through the config entries, record the component IDs so we can use them later if we need to\r\n    const componentIds: string[] = [];\r\n\r\n    const webpackEntries: { [name: string]: string } = {};\r\n    entries.forEach((entry: IBundleEntry) => {\r\n      const entryName: string = path.basename(entry.outputPath, '.js');\r\n      webpackEntries[entryName] = path.join(this.buildConfig.rootPath, entry.entry);\r\n\r\n      const manifest: IClientSideComponentManifest = this.getManifest(entry.manifest);\r\n      if (manifest) {\r\n        componentIds.push(manifest.id);\r\n      }\r\n    });\r\n\r\n    const libraryName: string = this.taskConfig.libraryName || (() => {\r\n      if (componentIds.length === 0) {\r\n        // If there are no component IDs, it doesn't appear as though we're generating a bundle that will be\r\n        //  loaded on the page, because the module loader requires an ID, so we shouldn't need to worry about\r\n        //  collisions in the webpackJsonp function.\r\n        return undefined;\r\n      } else if (componentIds.length === 1) {\r\n        return componentIds[0];\r\n      } else {\r\n        // If there are multiple component IDs, this is a project that is producing multiple components. For now,\r\n        //  we'll just concatenate them and then hash them so we end up with something unique (becuase that's all we\r\n        //  really care about). When we update this task to support multiple webpack configurations, we can seperate\r\n        //  each bundle to have its own library name.\r\n        return this.getChecksum(componentIds.join(''));\r\n      }\r\n    })();\r\n\r\n    const pathDirNames: string[] = this.buildConfig.rootPath.split(path.sep);\r\n    const lastDirName: string = pathDirNames[pathDirNames.length - 1] === ''\r\n      ? pathDirNames[pathDirNames.length - 2] : pathDirNames[pathDirNames.length - 1];\r\n    const configAddons: webpack.Configuration = {\r\n      context: this.buildConfig.rootPath,\r\n      devtool: this.buildConfig.production ? undefined : 'source-map',\r\n      entry: webpackEntries,\r\n      externals: externalsKeys.concat(localizedResourcesKeys),\r\n      output: {\r\n        chunkFilename: '[id].[name]_[chunkhash].js',\r\n        filename: '[name].js',\r\n        library: libraryName,\r\n        libraryTarget: this.taskConfig.libraryTarget || 'amd',\r\n        path: path.join(this.buildConfig.rootPath, this.buildConfig.distFolder),\r\n        devtoolModuleFilenameTemplate: 'webpack:///../[resource-path]',\r\n        devtoolFallbackModuleFilenameTemplate: 'webpack:///../[resource-path]?[hash]'\r\n      },\r\n      plugins: [\r\n        new StatsPlugin.StatsWriterPlugin({\r\n          /* tslint:disable:no-null-keyword */\r\n          fields: null,\r\n          /* tslint:enable:no-null-keyword */\r\n          filename: `${lastDirName}.stats.json`\r\n        }),\r\n        new VisualizerPlugin({\r\n          filename: `${lastDirName}.stats.html`\r\n        })\r\n      ]\r\n    };\r\n\r\n    if (this.buildConfig.production) {\r\n      configAddons.plugins.push(new webpack.optimize.UglifyJsPlugin({\r\n        compress: {\r\n          dead_code: true,\r\n          warnings: false\r\n        },\r\n        mangle: true\r\n      }));\r\n    }\r\n\r\n    configAddons.plugins.push(new webpack.DefinePlugin({\r\n      DEBUG: !this.buildConfig.production,\r\n      UNIT_TEST: false,\r\n      NPM_BUILD: isRunningInNpmMode\r\n    }));\r\n\r\n    let config: webpack.Configuration = this._appendToBaseConfig(configAddons);\r\n    if (this.taskConfig.additionalConfiguration) {\r\n      config = this.taskConfig.additionalConfiguration(config);\r\n    }\r\n\r\n    this._setWebpackConfig(config);\r\n\r\n    completeCallback();\r\n    return;\r\n  }\r\n\r\n  private _appendToBaseConfig(config: webpack.Configuration): webpack.Configuration {\r\n    /* tslint:disable:no-any */\r\n    return lodash.mergeWith({}, this._baseConfig, config, (value1: any, value2: any) => {\r\n    /* tslint:enable:no-any */\r\n      if (lodash.isArray(value1) && lodash.isArray(value2)) {\r\n        return lodash.concat(value1, value2);\r\n      } else {\r\n        return undefined;\r\n      }\r\n    });\r\n  }\r\n\r\n  private _logNoEntriesWarning(): void {\r\n    // @TODO: SPPPlat VSO 221536\r\n    // this.logWarning('No entries are defined, so no bundles will be produced.');\r\n  }\r\n\r\n  private _setWebpackConfig(config: webpack.Configuration): void {\r\n    const webpackTask: WebpackTask = this.taskConfig.webpack;\r\n    if (webpackTask) {\r\n      webpackTask.setConfig({\r\n        config: config,\r\n        configPath: webpackTask.taskConfig.configPath\r\n      });\r\n    }\r\n  }\r\n}\r\n"],"sourceRoot":"/source/"}