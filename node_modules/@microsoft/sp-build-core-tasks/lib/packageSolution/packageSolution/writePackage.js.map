{"version":3,"sources":["packageSolution/packageSolution/writePackage.ts"],"names":[],"mappings":"AAAA;;;;;GAKG;;AAEH,2BAA2B;AAE3B,wCAAwC;AAExC,QAAO,aAAa,CAAC,CAAA;AACrB,IAAO,MAAM,WAAW,QAAQ,CAAC,CAAC;AAClC,IAAY,IAAI,WAAM,MAAM,CAAC,CAAA;AAC7B,IAAO,KAAK,WAAW,QAAQ,CAAC,CAAC;AACjC,IAAO,EAAE,WAAW,IAAI,CAAC,CAAC;AAC1B,IAAO,KAAK,WAAW,UAAU,CAAC,CAAC;AAOnC,0BAAuB,cAAc,CAAC,CAAA;AAEtC;;GAEG;AACH,sBACwB,QAAqB,EAAE,MAAkC;IAC/E,IAAM,GAAG,GAAU,IAAI,KAAK,EAAE,CAAC;IAE/B,MAAM,CAAC,wBAAwB,CAAC,MAAM,CAAC;SACpC,IAAI,CAAC,cAAM,OAAA,OAAO,CAAC,GAAG,CACrB;QACE,YAAY,CAAC,QAAQ,CAAC,QAAQ,EAAE,MAAM,EAAE,GAAG,CAAC;QAC5C,YAAY,CAAC,QAAQ,CAAC,aAAa,EAAE,MAAM,EAAE,GAAG,CAAC;QACjD,YAAY,CAAC,QAAQ,CAAC,eAAe,EAAE,MAAM,EAAE,GAAG,CAAC;KACpD;SACA,MAAM,CAAC,QAAQ,CAAC,WAAW,CAAC,GAAG,CAAC,UAAC,UAAgB,IAAK,OAAA,YAAY,CAAC,UAAU,EAAE,MAAM,EAAE,GAAG,CAAC,EAArC,CAAqC,CAAC,CAAC;SAC7F,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,GAAG,CAAC,UAAC,OAAoB,IAAK,OAAA,YAAY,CAAC,OAAO,EAAE,MAAM,EAAE,GAAG,CAAC,EAAlC,CAAkC,CAAC,CAAC,CAC7F,EARW,CAQX,CAAC;SACD,IAAI,CAAC;QACJ,MAAM,CAAC,SAAS,CAAC,MAAM,CAAC,KAAK,CAAC,aAAa,EACzC,GAAG,CAAC,QAAQ,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,SAAS,EAAE,CAAC,EAAE,QAAQ,CAAC,CAAC;IACvE,CAAC,CAAC,CAAC;AACP,CAAC;AAlBD;8BAkBC,CAAA;AAED;;GAEG;AACH,kCAAyC,MAAkC;IACzE,MAAM,CAAC,IAAI,OAAO,CAAO,UAAC,QAAoB,EAAE,MAA8B;QAC5E,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,UAAC,KAAY;YACxC,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;gBACV,MAAM,CAAC,KAAK,CAAC,CAAC;gBACd,MAAM,CAAC;YACT,CAAC;YACD,OAAO,CAAC,GAAG,CAAC,aAAW,MAAM,CAAC,KAAK,CAAC,QAAU,CAAC,CAAC;YAChD,QAAQ,EAAE,CAAC;QACb,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC;AAXe,gCAAwB,2BAWvC,CAAA;AAED,sBACE,OAAoB,EACpB,MAAkC,EAClC,GAAe;IAEf,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC;QACjB,YAAY,CAAC,OAAO,EAAE,MAAM,EAAE,GAAG,CAAC;QAClC,YAAY,CAAC,OAAO,CAAC,MAAM,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC;SACzC,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,GAAG,CAAC,UAAC,SAAe,IAAK,OAAA,YAAY,CAAC,SAAS,EAAE,MAAM,EAAE,GAAG,CAAC,EAApC,CAAoC,CAAC,CAAC,CAAC,CAAC;AAChG,CAAC;AATe,oBAAY,eAS3B,CAAA;AAED,sBAA6B,IAAU,EAAE,MAAkC,EAAE,GAAe;IAC1F,MAAM,CAAC,eAAe,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,GAAG,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC;AAC/D,CAAC;AAFe,oBAAY,eAE3B,CAAA;AAED,sBAA6B,IAAgC,EAAE,MAAkC,EAC3E,GAAe;IACnC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC;QACjB,eAAe,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,GAAG,EAAE,MAAM,EAAE,GAAG,CAAC;QACrD,YAAY,CAAC,IAAI,CAAC,aAAa,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC,CAAE;AACrD,CAAC;AALe,oBAAY,eAK3B,CAAA;AAED;;GAEG;AACH,yBAAyB,QAAgB,EAAE,QAAgB,EAAE,MAAkC,EACtE,GAAe;IACtC,IAAM,QAAQ,GAAW,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;IACpE,MAAM,CAAC,kBAAM,CAAC;QACZ,cAAM,OAAA,eAAe,CAAC,QAAQ,CAAC,EAAzB,CAAyB;QAC/B,cAAM,OAAA,SAAS,CAAC,QAAQ,EAAE,QAAQ,CAAC,EAA7B,CAA6B;QACnC,cAAM,OAAA,YAAY,CAAC,QAAQ,EAAE,QAAQ,EAAE,GAAG,CAAC,EAArC,CAAqC,CAAC,CAAC,CAAC;AAClD,CAAC;AAED;;GAEG;AACH,yBAAyB,QAAgB;IACvC,MAAM,CAAC,IAAI,OAAO,CAAO,UAAC,QAAmB,EAAE,MAA8B;QAC3E,IAAM,WAAW,GAAa,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QACvD,WAAW,CAAC,GAAG,EAAE,CAAC;QAClB,IAAM,UAAU,GAAW,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAEtD,MAAM,CAAC,UAAU,EAAE,UAAC,GAAU;YAC5B,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;gBACR,MAAM,CAAC,GAAG,CAAC,CAAC;gBACZ,MAAM,CAAC;YACT,CAAC;YACD,QAAQ,EAAE,CAAC;QACb,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC;AAED;;GAEG;AACH,mBAAmB,QAAgB,EAAE,QAAgB,EAAE,IAAa;IAClE,MAAM,CAAC,IAAI,OAAO,CAAO,UAAC,QAAoB,EAAE,MAA8B;QAC5E,EAAE,CAAC,SAAS,CAAC,QAAQ,EAAE,QAAQ,EAAE,IAAI,EAAE,UAAC,KAAY;YAClD,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;gBACV,MAAM,CAAC,KAAK,CAAC,CAAC;gBACd,MAAM,CAAC;YACT,CAAC;YACD,OAAO,CAAC,GAAG,CAAC,mBAAiB,QAAU,CAAC,CAAC;YACzC,QAAQ,EAAE,CAAC;QACb,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC;AAED;;GAEG;AACH,sBAAsB,QAAgB,EAAE,OAAe,EAAE,GAAe;IACtE,MAAM,CAAC,IAAI,OAAO,CAAO,UAAC,QAAoB,EAAE,MAA8B;QAC5E,IAAM,WAAW,GAAa,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QACvD,IAAM,IAAI,GAAW,WAAW,CAAC,GAAG,EAAE,CAAC;QACvC,GAAG,CAAC,CAAc,UAAW,EAAX,2BAAW,EAAX,yBAAW,EAAX,IAAW,CAAC;YAAzB,IAAM,GAAG,oBAAA;YACZ,GAAG,GAAG,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;SACvB;QACD,GAAG,CAAC,IAAI,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;QACxB,QAAQ,EAAE,CAAC;IACb,CAAC,CAAC,CAAC;AACL,CAAC","file":"packageSolution/packageSolution/writePackage.js","sourcesContent":["/**\r\n * @file writePackage.ts\r\n * @Copyright (c) Microsoft Corporation.  All rights reserved.\r\n *\r\n * Writes a package xml object to disk, in both raw and zipped format\r\n */\r\n\r\n/* tslint:disable:no-any */\r\n\r\n/// <reference path='./node-zip.d.ts' />\r\n\r\nimport 'es6-promise';\r\nimport mkdirp = require('mkdirp');\r\nimport * as path from 'path';\r\nimport rmdir = require('rimraf');\r\nimport fs = require('fs');\r\nimport JSZip = require('node-zip');\r\n\r\nimport IXml from './models/packageXml/IXml';\r\nimport IOpenDocumentConventionXml from './models/packageXml/IOpenDocumentConventionXml';\r\nimport IPackageXml from './models/packageXml/IPackageXml';\r\nimport IFeatureXml from './models/packageXml/IFeatureXml';\r\nimport { IPackageSolutionTaskConfig } from '../PackageSolutionTask';\r\nimport { serial } from '../utilities';\r\n\r\n/**\r\n * Writes the ISolutionXml object containing the solution package xml to the disk using provided config\r\n */\r\nexport default\r\n  function writePackage(solution: IPackageXml, config: IPackageSolutionTaskConfig): Promise<any> {\r\n  const zip: JSZip = new JSZip();\r\n\r\n  return cleanRawPackageDirectory(config)\r\n    .then(() => Promise.all(\r\n      [\r\n        writeODCFile(solution.manifest, config, zip),\r\n        writeXmlFile(solution.relationships, config, zip),\r\n        writeXmlFile(solution.contentTypesXml, config, zip)\r\n      ]\r\n      .concat(solution.customFiles.map((customFile: IXml) => writeXmlFile(customFile, config, zip)))\r\n      .concat(solution.features.map((feature: IFeatureXml) => writeFeature(feature, config, zip)))\r\n    ))\r\n    .then(() => {\r\n      return writeFile(config.paths.zippedPackage,\r\n        zip.generate({ base64: false, compression: 'DEFLATE' }), 'binary');\r\n    });\r\n}\r\n\r\n/**\r\n * Ensures that the contents of config.paths.debugDir have been deleted\r\n */\r\nexport function cleanRawPackageDirectory(config: IPackageSolutionTaskConfig): Promise<void> {\r\n  return new Promise<void>((complete: () => void, reject: (error: Error) => void) => {\r\n    rmdir(config.paths.debugDir, (error: Error) => {\r\n      if (error) {\r\n        reject(error);\r\n        return;\r\n      }\r\n      console.log(`Cleaned ${config.paths.debugDir}`);\r\n      complete();\r\n    });\r\n  });\r\n}\r\n\r\nexport function writeFeature(\r\n  feature: IFeatureXml,\r\n  config: IPackageSolutionTaskConfig,\r\n  zip: ZipPackage\r\n): Promise<any> {\r\n  return Promise.all([\r\n    writeODCFile(feature, config, zip),\r\n    writeXmlFile(feature.config, config, zip)]\r\n    .concat(feature.components.map((component: IXml) => writeXmlFile(component, config, zip))));\r\n}\r\n\r\nexport function writeXmlFile(file: IXml, config: IPackageSolutionTaskConfig, zip: ZipPackage): Promise<void> {\r\n  return writeFileToPath(file.filename, file.xml, config, zip);\r\n}\r\n\r\nexport function writeODCFile(file: IOpenDocumentConventionXml, config: IPackageSolutionTaskConfig,\r\n                      zip: ZipPackage): Promise<any> {\r\n  return Promise.all([\r\n    writeFileToPath(file.filename, file.xml, config, zip),\r\n    writeXmlFile(file.relationships, config, zip)]) ;\r\n}\r\n\r\n/**\r\n * Physically writes a file to disk, and adds to an in-memory zip package\r\n */\r\nfunction writeFileToPath(filename: string, contents: string, config: IPackageSolutionTaskConfig,\r\n                         zip: ZipPackage): Promise<void> {\r\n  const filepath: string = path.join(config.paths.debugDir, filename);\r\n  return serial([\r\n    () => ensureDirectory(filepath),\r\n    () => writeFile(filepath, contents),\r\n    () => addFileToZip(filename, contents, zip)]);\r\n}\r\n\r\n/**\r\n * Returns a promise which ensures a directory on disk exists using mkdirp\r\n */\r\nfunction ensureDirectory(filepath: string): Promise<void> {\r\n  return new Promise<void>((complete: () => any, reject: (error: Error) => void) => {\r\n    const directories: string[] = filepath.split(path.sep);\r\n    directories.pop();\r\n    const pathToFile: string = directories.join(path.sep);\r\n\r\n    mkdirp(pathToFile, (err: Error) => {\r\n      if (err) {\r\n        reject(err);\r\n        return;\r\n      }\r\n      complete();\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Wraps fs.writeFile in a promise\r\n */\r\nfunction writeFile(filename: string, contents: string, flag?: string): Promise<void> {\r\n  return new Promise<void>((complete: () => void, reject: (error: Error) => void) => {\r\n    fs.writeFile(filename, contents, flag, (error: Error) => {\r\n      if (error) {\r\n        reject(error);\r\n        return;\r\n      }\r\n      console.log(`Created file: ${filename}`);\r\n      complete();\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Adds a file to a zip package\r\n */\r\nfunction addFileToZip(filepath: string, content: string, zip: ZipPackage): Promise<void> {\r\n  return new Promise<void>((complete: () => void, reject: (error: Error) => void) => {\r\n    const directories: string[] = filepath.split(path.sep);\r\n    const file: string = directories.pop();\r\n    for (const dir of directories) {\r\n      zip = zip.folder(dir);\r\n    }\r\n    zip.file(file, content);\r\n    complete();\r\n  });\r\n}\r\n"],"sourceRoot":"/source/"}