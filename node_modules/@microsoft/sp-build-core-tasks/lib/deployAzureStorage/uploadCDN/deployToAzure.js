/**
 * @file deployToAzure.ts
 * @Copyright (c) Microsoft Corporation.  All rights reserved.
 *
 * Uploads source files to an Azure Blob Storage instance
 */
"use strict";
require('es6-promise');
var glob = require('glob');
var colors = require('colors');
var ensureBlobService_1 = require('./azureStorage/ensureBlobService');
var ensureContainer_1 = require('./azureStorage/ensureContainer');
var uploadFilesToAzure_1 = require('./azureStorage/uploadFilesToAzure');
/**
 * Uses glob to expand the filepath glob into a list of resolved file paths
 */
function loadSourceFiles(globs, cwd) {
    return new Promise(function (complete, reject) {
        var options = cwd ? { cwd: cwd } : {};
        glob(globs, options, function (err, matches) {
            if (err) {
                reject(err);
            }
            else {
                complete(matches);
            }
        });
    });
}
/**
 * Deploys all the files in a certain directory to a specific Azure Blob Storage instance
 */
function deployToAzure(config) {
    if (!config.container) {
        return new Promise(function (complete, reject) {
            reject(new Error('Config file missing container name!'));
        });
    }
    if (!config.account) {
        return new Promise(function (complete, reject) {
            reject(new Error('Config file missing Azure account name!'));
        });
    }
    if (!config.accessKey) {
        return new Promise(function (complete, reject) {
            reject(new Error('Config file missing Azure access key!'));
        });
    }
    console.log("Uploading files '" + config.uploadPath + "' from directory '" + config.workingDir + "' to Azure");
    return loadSourceFiles(config.uploadPath, config.workingDir)
        .then(function (files) {
        return ensureBlobService_1.default(config.account, config.accessKey)
            .then(function (blobService) { return ensureContainer_1.default(blobService, config.container); })
            .then(function (blobService) {
            return uploadFilesToAzure_1.default(blobService, config.container, config.workingDir, files);
        })
            .then(function () {
            console.log(colors.green('Upload complete!\n'));
            console.log('Access your files at: http://%s.blob.core.windows.net/%s/\n', config.account, config.container);
        }, function (error) {
            console.error(error);
            if (error.stack) {
                console.error(error.stack);
            }
        });
    });
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = deployToAzure;

//# sourceMappingURL=deployToAzure.js.map
