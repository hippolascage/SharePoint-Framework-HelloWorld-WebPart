{"version":3,"sources":["TypeScriptTask.ts"],"names":[],"mappings":"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","file":"TypeScriptTask.js","sourcesContent":["import { GulpTask } from 'gulp-core-build';\nimport gulpType = require('gulp');\nimport ts = require('gulp-typescript');\n\ninterface ITypeScriptErrorObject {\n  diagnostic: {\n    messageText:  string | { messageText: string };\n    code: number;\n  };\n  fullFilename: string;\n  relativeFilename: string;\n  message: string;\n  startPosition: {\n    character: number;\n    line: number;\n  };\n}\n\nexport interface ITypeScriptTaskConfig {\n  failBuildOnErrors: boolean;\n  sourceMatch?: string[];\n  staticMatch?: string[];\n  reporter?: ts.Reporter;\n}\n\nexport class TypeScriptTask extends GulpTask<ITypeScriptTaskConfig> {\n  public name: string = 'typescript';\n\n  public taskConfig: ITypeScriptTaskConfig = {\n    failBuildOnErrors: true,\n    reporter: {\n      error: (error: ITypeScriptErrorObject): void => {\n        const errorMessage: string = (typeof error.diagnostic.messageText === 'object') ?\n          (error.diagnostic.messageText as { messageText: string }).messageText :\n          error.diagnostic.messageText as string;\n\n        this.fileError(\n          error.relativeFilename || error.fullFilename,\n          error.startPosition.line,\n          error.startPosition.character,\n          `TS${error.diagnostic.code}`,\n          errorMessage);\n      }\n    },\n    sourceMatch: [\n      'src/**/*.ts',\n      'src/**/*.tsx',\n      'typings/main/**/*.ts',\n      'typings/main.d.ts',\n      'typings/tsd.d.ts',\n      'typings/index.d.ts'\n    ],\n    staticMatch: [\n      'src/**/*.js',\n      'src/**/*.json',\n      'src/**/*.jsx'\n    ]\n  };\n\n  private _tsProject: ts.Project;\n\n  public executeTask(gulp: gulpType.Gulp, completeCallback: (result?: string) => void): void {\n    /* tslint:disable:typedef */\n    const plumber = require('gulp-plumber');\n    const sourcemaps = require('gulp-sourcemaps');\n    const assign = require('object-assign');\n    const merge = require('merge2');\n    /* tslint:enable:typedef */\n\n    let errorCount: number = 0;\n    const allStreams: NodeJS.ReadWriteStream[] = [];\n    const tsConfig: ts.TsConfig = this.readJSONSync('tsconfig.json') || require('../tsconfig.json');\n\n    const tsCompilerOptions: ts.Params = assign({}, tsConfig.compilerOptions, {\n      module: 'commonjs',\n      sortOutput: true\n    });\n\n    const tsProject: ts.Project = this._tsProject = this._tsProject || ts.createProject(tsCompilerOptions);\n\n    /* tslint:disable:typedef */\n    const { libFolder, libAMDFolder } = this.buildConfig;\n    /* tslint:enable:typedef */\n    let tsResult: ts.CompilationStream = gulp.src(this.taskConfig.sourceMatch)\n      .pipe(plumber({\n        errorHandler: (): void => {\n          errorCount++;\n        }\n      }))\n      .pipe(sourcemaps.init())\n      .pipe(ts(tsProject, undefined, this.taskConfig.reporter));\n\n    allStreams.push(tsResult.js\n      .pipe(sourcemaps.write('.', { sourceRoot: '/src' }))\n      .pipe(gulp.dest(libFolder)));\n\n    allStreams.push(tsResult.dts.pipe(gulp.dest(libFolder)));\n\n    // Static passthrough files.\n    const staticSrc: NodeJS.ReadWriteStream = gulp.src(this.taskConfig.staticMatch);\n\n    allStreams.push(\n      staticSrc.pipe(gulp.dest(libFolder)));\n\n    // If AMD modules are required, also build that.\n    if (libAMDFolder) {\n      allStreams.push(\n        staticSrc.pipe(gulp.dest(libAMDFolder)));\n\n      const tsAMDProject: ts.Project = ts.createProject(assign({}, tsCompilerOptions, { module: 'amd' }));\n\n      tsResult = gulp.src(this.taskConfig.sourceMatch)\n        .pipe(plumber({\n          errorHandler: (): void => {\n            errorCount++;\n          }\n        }))\n        .pipe(sourcemaps.write({ sourceRoot: '/src' }))\n        .pipe(ts(tsAMDProject, undefined, this.taskConfig.reporter));\n\n      allStreams.push(\n        tsResult.js\n          .pipe(sourcemaps.write('.', { sourceRoot: '/src' }))\n          .pipe(gulp.dest(libAMDFolder)));\n\n      allStreams.push(tsResult.dts.pipe(gulp.dest(libAMDFolder)));\n    }\n\n    // Listen for pass/fail, and ensure that the task passes/fails appropriately.\n    merge(allStreams)\n      .on('queueDrain', () => {\n        if (this.taskConfig.failBuildOnErrors && errorCount) {\n          completeCallback('TypeScript error(s) occurred.');\n        } else {\n          completeCallback();\n        }\n      })\n      .on('error', completeCallback);\n  }\n}\n"],"sourceRoot":"/source/"}